<!DOCTYPE html>
<html>
  <head>
    <title>How to setup a typescript monorepo using NPM</title>
    <style>
      .container {
        font-family: Arial, Helvetica, sans-serif;
        width: 50em;
        margin: auto;
      }

      pre,
      code {
        background-color: lightgoldenrodyellow;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>How to setup a typescript monorepo using NPM</h1>

      <p>
        Here I wrote a summary about the article at
        <a href="https://earthly.dev/blog/setup-typescript-monorepo"
          >earthly.dev/blog/setup-typescript-monorepo</a
        >
        on the 1st of August, 2023.
      </p>

      <h2>Initialize the Directory Structure</h2>

      <pre>
typescript-monorepo
├── src
├── node_modules
├── ...
└── packages
		</pre
      >

      <pre>
# create the monorepo root directory
mkdir typescript-monorepo

# enter the newly created directory
cd typescript-monorepo

# creating the subdirectory
mkdir src
mkdir packages
		</pre
      >

      <h2>Define the Global <code>package.json</code> File</h2>

      <p>
        Inside the <code>monorepo-typescript</code> directory, launch the
        following command:
      </p>

      <pre>
npm init -y
		</pre
      >

      <p>Now, let's update the /package.json as follows:</p>
      <pre>
{
  "name": "monorepo-typescript",
  "version": "1.0.0",
  "description": "A monorepo in TypeScript",
  "private": true,
  "workspaces": [
    "packages/*"
  ]
}
		</pre
      >

      <p>
        With this configuration, every folder inside <code>/packages</code> with
        a
        <code>package.json</code>
        file is considered a local package. When you run
        <code>npm install</code> in the root directory, folders within
        <code>packages/</code> are symlinked to the
        <code>node_modules</code> folder.
      </p>

      <h2>Add the Core Dependencies</h2>

      <p>Install these to your root project's dependencies:</p>

      <pre>
npm install typescript
npm install --save-dev @types/node ts-node
		</pre
      >

      <p>
        <code>ts-node</code> transforms TypeScript into JavaScript and allows
        you to execute TypeScript on Node.js without precompiling.
      </p>

      <p>You should add <code>eslint</code> and <code>prettier</code>:</p>

      <pre>
npm install eslint prettier @typescript-eslint/parser @typescript-eslint/eslint-plugin
		</pre
      >

      <p>
        Then, create an <u>eslint configuration file</u>. For example, you can
        initialize a <code>.eslintrc.json</code> file as follows:
      </p>

      <pre>
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": [
    "@typescript-eslint"
  ]
}
		</pre
      >

      <p>
        Similarly, create a <u>prettier configuration file</u>. Again, you can
        define a <code>.prettierrc.json</code> file as below:
      </p>

      <pre>
{
  "trailingComma": "all",
  "tabWidth": 2,
  "printWidth": 120,
  "semi": false,
  "singleQuote": false,
  "bracketSpacing": true
}
		</pre
      >

      <h2>Add a Local Package</h2>

      <p>
        First, create the <code>utils</code> folder inside
        <code>/packages</code>:
      </p>
      <pre>
mkdir utils
		</pre
      >

      <p>
        Initialize a <code>package.json</code> file inside
        <code>utils</code> with this <code>npm</code> command:
      </p>

      <pre>
npm init --scope @monorepo --workspace ./packages/utils -y
		</pre
      >

      <p>
        The <code>--scope</code> flag specifies an <u>npm scope name</u> in the
        package name. You should adopt the same npm scope name for all your
        local packages.
      </p>

      <p>
        This keeps your monorepo <code>node_modules</code> directory cleaner, as
        all your local packages will appear as links in the same
        <code>@&apos;scope_name&apos;</code> folder. Also, it makes local
        imports more elegant and easy to recognize from global npm libraries.
      </p>

      <p>Make sure <code>package.json</code> contains the following content:</p>

      <pre>
{
  "name": "@monorepo/utils",
  "version": "1.0.0",
  "description": "The package containing some utility functions",
  "main": "build/index.js",
  "scripts": {
    "build": "tsc --build"
  }
}
		</pre
      >

      <p>
        You also need a <code>tsconfig.json</code> file. Initialize it as
        follows:
      </p>

      <pre>
{
    "compilerOptions": {
        "target": "es2022",
        "module": "commonjs",
        "moduleResolution": "node",
        "declaration": true,
        "strict": true,
        "incremental": true,
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true,
        "rootDir": "./src",
        "outDir": "./build",
        "composite": true
    }
}
		</pre
      >

      <p>
        As explained in the
        <a
          href="https://www.typescriptlang.org/docs/handbook/project-references.html#composite"
          >TypeScript documentation</a
        >, set the <code>composite</code> option to <code>true</code>. Since
        you're likely to reference this project in other parts of the monorepo,
        this enables you to reference this package in other
        <code>tsconfig.json</code>.
      </p>

      <p>Then create a <code>src</code> directory:</p>
      <pre>
cd packages/utils
mkdir src
		</pre
      >

      <p>Then, initialize an <code>index.ts</code> file as follows:</p>

      <pre>
export function isEven(n: number): boolean {
    return n % 2 === 0
}
		</pre
      >

      <h2>Verify That the Local Package Works</h2>
      <pre>
npm run build --workspace ./packages/utils
		</pre
      >

      <p>
        Make sure to launch it in the root directory of the monorepo. This
        command executes the <code>build</code> script defined in the local
        <code>package.json</code>
        of the package specified with the <code>--workspace</code> flag. Don't
        forget that a local package is nothing more than an npm workspace, which
        is why you need to use the <code>--workspace</code> flag.
      </p>

      <h2>Define a Global <code>tsconfig.json</code> File</h2>

      <p>
        Initialize a <code>tsconfig.json</code> file in the root directory with
        the following content:
      </p>

      <pre>
{
  "compilerOptions": {
    "incremental": true,
    "target": "es2022",
    "module": "commonjs",
    "declaration": true,
    "strict": true,
    "moduleResolution": "node",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "rootDir": "./src",
    "outDir": "./build"
  },
  "files": [
  ],
  "references": [
    {
      "path": "./packages/utils"
    }
  ]
}
		</pre
      >

      <p>
        Thanks to
        <a
          href="https://www.typescriptlang.org/docs/handbook/project-references.html"
          >TypeScript references</a
        >, you can split a TypeScript project into smaller parts. With the
        <code>references</code> option, you can define the list of packages your
        TypeScript monorepo consists of. When running
        <code>tsc --build</code> in the root directory, the TypeScript compiler
        accesses all packages defined in <code>references</code> and compiles
        them one by one in order.
      </p>

      <p>
        Add a new <code>build</code> script in the global
        <code>./package.json</code> file:
      </p>
      <pre>
"scripts": {
  "build": "tsc --build --verbose"
}
		</pre
      >

      <h2>Use a Local Package Inside Another Local Package</h2>

      <p>
        Now, let's assume you want to use some utility functions from the
        <code>@monorepo/utils</code> in the <code>@monorepo/ui</code> package.
        All you have to do is run the following npm command in the root
        directory:
      </p>

      <pre>
npm install @monorepo/utils --workspace ./packages/ui
		</pre
      >

      <p>
        This adds <code>@monorepo/utils</code> as a dependency in
        <code>@monorepo/utils</code>.
      </p>

      <p>
        Take a look at the local <code>package.json</code> file inside
        <code>./packages/ui</code> and you'll see:
      </p>

      <pre>
"dependencies": {
  "@monorepo/utils": "^1.0.0"
}
		</pre
      >

      <p>
        Now, in <code>./packages/ui/index.ts</code>, you can access the utility
        functions exposed by <code>@monorepo/utils</code> as follows:
      </p>

      <pre>
import { isEven } from "@monorepo/utils";
		</pre
      >

      <h2>Add an External npm Package to a Local Package</h2>

      <p>
        In this case, don't run an <code>npm install</code> command inside the
        package folder; that would add the dependency to the local
        <code>package.json</code>
        file and consequently generate a locale
        <code>node_modules</code> folder. This violates the core idea that a
        monorepo has only one <code>node_modules</code>.
      </p>

      <p>
        Let's assume you want to add
        <a href="https://www.npmjs.com/package/moment">moment</a> to the
        <code>@monorepo/ui</code> package. Run the following
        <code>npm install</code> command in the root folder of your monorepo:
      </p>
      <pre>
npm install moment --workspace ./packages/ui
		</pre
      >

      <p>
        This installs <code>moment</code> in the monorepo's
        <code>node_modules</code> folder and adds the following section to the
        local <code>packages.json</code> inside <code>./packages/ui</code>:
      </p>

      <pre>
"dependencies": {
  // ...
  "moment": "^2.29.4"
}
		</pre
      >

      <pre>
import moment from "moment"
		</pre
      >

      <h2>Putting It All Together</h2>

      <p>
        Now, add <code>@monorepo/utils</code> and <code>@monorepo/ui</code> as
        project dependencies in the global <code>./package.json</code> file with
        this npm command:
      </p>

      <pre>
npm install @monorepo/utils @monorepo/ui
		</pre
      >
    </div>
  </body>
</html>
